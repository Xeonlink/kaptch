<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Labeling Tool</title>
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #f7f7f7;
            --bg-secondary: #fff;
            --bg-tertiary: #f0f0f0;
            --bg-quaternary: #eee;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #888;
            --text-placeholder: #999;
            --text-disabled: #aaa;
            --border-primary: #ccc;
            --border-secondary: #bbb;
            --border-tertiary: #555;
            --shadow: rgba(0,0,0,0.1);
            --button-hover: #e6e6e6;
            --button-disabled: #eee;
            --input-bg: #fff;
            --select-bg: #fff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark mode colors */
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-tertiary: #404040;
                --bg-quaternary: #1a1a1a;
                --text-primary: #e0e0e0;
                --text-secondary: #ccc;
                --text-tertiary: #bbb;
                --text-placeholder: #aaa;
                --text-disabled: #666;
                --border-primary: #555;
                --border-secondary: #555;
                --border-tertiary: #555;
                --shadow: rgba(0,0,0,0.3);
                --button-hover: #4a4a4a;
                --button-disabled: #2a2a2a;
                --input-bg: #404040;
                --select-bg: #404040;
            }
        }

        body { 
            font-family: sans-serif; 
            background: var(--bg-primary); 
            margin: 0; 
            padding: 0; 
            color: var(--text-primary); 
        }
        .container { 
            max-width: 520px; 
            margin: 40px auto; 
            background: var(--bg-secondary); 
            border-radius: 8px; 
            box-shadow: 0 2px 8px var(--shadow); 
            padding: 24px; 
        }
        h1 { 
            font-size: 1.5em; 
            margin-bottom: 16px; 
            color: var(--text-primary); 
        }
        #image-preview { 
            display: block; 
            margin: 0 auto 16px auto; 
            max-width: 100%; 
            max-height: 240px; 
            border: 1px solid var(--border-primary); 
            background: white; 
        }
        .controls { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 12px; 
        }
        .controls button { 
            flex: 1; 
            padding: 8px 0; 
            font-size: 1em; 
            border-radius: 4px; 
            border: 1px solid var(--border-secondary); 
            background: var(--bg-tertiary); 
            color: var(--text-primary); 
            cursor: pointer; 
        }
        .controls button:hover { 
            background: var(--button-hover); 
        }
        .controls button:disabled { 
            background: var(--button-disabled); 
            color: var(--text-disabled); 
            cursor: not-allowed; 
        }
        #label-input { 
            width: 100%; 
            font-size: 1.1em; 
            padding: 8px; 
            margin-bottom: 12px; 
            border-radius: 4px; 
            border: 1px solid var(--border-secondary); 
            background: var(--input-bg); 
            color: var(--text-primary); 
        }
        #label-input::placeholder { 
            color: var(--text-placeholder); 
        }
        #progress { 
            text-align: center; 
            margin-bottom: 8px; 
            color: var(--text-secondary); 
        }
        #step { 
            color: var(--text-tertiary); 
            font-size: 0.98em; 
            margin-bottom: 8px; 
        }
        select { 
            background: var(--select-bg); 
            color: var(--text-primary); 
            border: 1px solid var(--border-secondary); 
            border-radius: 4px; 
            padding: 4px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dataset Labeling Tool</h1>
        <div id="step">CSV 파일을 선택하세요.</div>
        <select id="csv-select">
            <option value="train">train_list.csv</option>
            <option value="test">test_list.csv</option>
        </select>
        <div id="progress"></div>
        <img id="image-preview" src="" alt="Preview" style="display:none;" />
        <input type="text" id="label-input" placeholder="라벨을 입력하세요" autocomplete="off" style="display:none;" />
        <div class="controls">
            <button id="prev-btn" disabled>이전</button>
            <button id="next-btn" disabled>다음</button>
        </div>
    </div>
    <script>
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        const csvSelect = document.getElementById('csv-select');
        const imagePreview = document.getElementById('image-preview');
        const labelInput = document.getElementById('label-input');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progress = document.getElementById('progress');
        const step = document.getElementById('step');

        let csvRows = [];
        let labelColIdx = 1;
        let unlabeledIdxs = [];
        let curUnlabeled = 0;
        let csvType = 'train';

        csvSelect.addEventListener('change', () => {
            csvType = csvSelect.value;
            fetchAndInit();
        });

        function fetchAndInit() {
            fetch(`/api/csv?type=${csvType}`)
                .then(r => r.json())
                .then(data => {
                    csvRows = data.rows;
                    labelColIdx = data.labelColIdx;
                    unlabeledIdxs = [];
                    for (let i = 0; i < csvRows.length; i++) {
                        if ((csvRows[i][labelColIdx] ?? '') === '') {
                            unlabeledIdxs.push(i);
                        }
                    }
                    // 무작위 셔플
                    shuffle(unlabeledIdxs);
                    curUnlabeled = 0;
                    if (unlabeledIdxs.length > 0) {
                        showImage();
                        labelInput.style.display = '';
                        imagePreview.style.display = '';
                        prevBtn.disabled = false;
                        nextBtn.disabled = false;
                        labelInput.focus();
                        step.textContent = '라벨을 입력하고 Enter를 누르세요.';
                    } else {
                        imagePreview.style.display = 'none';
                        labelInput.style.display = 'none';
                        progress.textContent = '라벨이 필요한 이미지가 없습니다!';
                        step.textContent = '완료!';
                    }
                });
        }

        function showImage() {
            if (unlabeledIdxs.length === 0) return;
            const csvIdx = unlabeledIdxs[curUnlabeled];
            const row = csvRows[csvIdx];
            const imgPath = row[0];
            fetch(`/api/image/${encodeURIComponent(imgPath)}`)
                .then(r => {
                    if (!r.ok) throw new Error('이미지 없음');
                    return r.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    imagePreview.src = url;
                    imagePreview.onload = () => URL.revokeObjectURL(url);
                })
                .catch(() => {
                    imagePreview.style.display = 'none';
                    progress.textContent = '이미지 파일이 없습니다: ' + imgPath;
                });
            labelInput.value = row[labelColIdx] || '';
            progress.textContent = `${curUnlabeled + 1} / ${unlabeledIdxs.length} (전체 ${csvRows.length})`;
            prevBtn.disabled = curUnlabeled === 0;
            nextBtn.disabled = curUnlabeled === unlabeledIdxs.length - 1;
        }

        labelInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveLabelAndNext();
                e.preventDefault();
            }
        });

        function saveLabelAndNext() {
            if (unlabeledIdxs.length === 0) return;
            const csvIdx = unlabeledIdxs[curUnlabeled];
            const label = labelInput.value;
            fetch('/api/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: csvType,
                    idx: csvIdx,
                    label: label
                })
            }).then(() => {
                csvRows[csvIdx][labelColIdx] = label;
                // 다음 미라벨 이미지로 이동
                let found = false;
                for (let i = curUnlabeled + 1; i < unlabeledIdxs.length; i++) {
                    if ((csvRows[unlabeledIdxs[i]][labelColIdx] ?? '') === '') {
                        curUnlabeled = i;
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    fetchAndInit();
                } else {
                    showImage();
                    labelInput.focus();
                }
            });
        }

        prevBtn.addEventListener('click', () => {
            if (curUnlabeled > 0) {
                curUnlabeled--;
                showImage();
                labelInput.focus();
            }
        });
        nextBtn.addEventListener('click', () => {
            if (curUnlabeled < unlabeledIdxs.length - 1) {
                saveLabelAndNext();
                e.preventDefault();
            }
        });

        // 최초 로딩
        fetchAndInit();
    </script>
</body>
</html>